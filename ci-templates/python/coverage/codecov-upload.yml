# Generic GitHub Actions workflow: generate a coverage report and upload it to Codecov (works with pytest or unittest)

name: Codecov Coverage Report Upload
on:
  push:
    paths:
      - '**/*.py'                       # Trigger on Python file changes
      - '.github/workflows/**'          # Trigger when workflow files change
  pull_request:
    paths:
      - '**/*.py'
      - '.github/workflows/**'
  workflow_dispatch: {}                 # Allow manual runs

concurrency:
  group: codecov-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  codecov-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'         # Use the latest available 3.x

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies and coverage
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install coverage || true

      - name: Run tests and produce coverage.xml
        run: |
          set -e
          # Prefer pytest if available (installed via requirements.txt); otherwise run unittest
          if python -c "import pytest" >/dev/null 2>&1; then
            pytest --maxfail=1 --disable-warnings -q --cov=.
            coverage xml
          else
            coverage run -m unittest discover
            coverage xml
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }} # Optional for public repos; required for private repos